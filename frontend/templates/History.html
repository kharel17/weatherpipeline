{% extends "base.html" %} {% block title %}{{ history.location.name }} - Weather
History{% endblock %} {% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-cyan-50">
  <!-- History Header -->
  <section class="bg-gradient-to-r from-green-600 to-blue-700 text-white py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
        <!-- Location Info -->
        <div class="mb-6 lg:mb-0">
          <h1 class="text-3xl lg:text-4xl font-bold mb-2">Weather History</h1>
          <h2 class="text-xl text-blue-100 mb-2">
            {{ history.location.name }}
          </h2>
          <p class="text-blue-100">
            üìç {{ "%.4f"|format(history.location.lat) }}, {{
            "%.4f"|format(history.location.lon) }}
          </p>
        </div>

        <!-- Quick Actions -->
        <div class="flex flex-wrap gap-3">
          <a
            href="{{ url_for('weather', lat=history.location.lat, lon=history.location.lon) }}"
            class="bg-white/20 backdrop-blur-sm border border-white/30 text-white px-4 py-2 rounded-lg hover:bg-white/30 transition-colors"
          >
            <svg
              class="w-4 h-4 inline mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"
              ></path>
            </svg>
            Current Weather
          </a>

          {% if forecasting_available %}
          <a
            href="{{ url_for('forecast', lat=history.location.lat, lon=history.location.lon) }}"
            class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition-colors font-medium"
          >
            <svg
              class="w-4 h-4 inline mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 10V3L4 14h7v7l9-11h-7z"
              ></path>
            </svg>
            View Forecast
          </a>
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  {% if history.records %}
  <!-- Historical Data Summary -->
  <section class="py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">
          Historical Data Summary
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
          <!-- Total Records -->
          <div class="text-center p-4 bg-blue-50 rounded-lg">
            <div class="text-3xl font-bold text-blue-600">
              {{ history.records|length }}
            </div>
            <div class="text-sm text-gray-600 mt-2">Total Records</div>
          </div>

          <!-- Date Range -->
          <div class="text-center p-4 bg-green-50 rounded-lg">
            <div class="text-lg font-bold text-green-600">
              {% set oldest = history.records[-1] if history.records else None
              %} {% set newest = history.records[0] if history.records else None
              %} {% if oldest and newest %} {{ (newest.created_at.date() -
              oldest.created_at.date()).days + 1 }} days {% else %} N/A {% endif
              %}
            </div>
            <div class="text-sm text-gray-600 mt-2">Data Span</div>
          </div>

          <!-- Temperature Range -->
          <div class="text-center p-4 bg-red-50 rounded-lg">
            <div class="text-lg font-bold text-red-600">
              {% set temps = history.records | map(attribute='current_temp_c') |
              reject('none') | list %} {% if temps %} {{ "%.1f"|format(temps |
              max) }}¬∞C {% else %} N/A {% endif %}
            </div>
            <div class="text-sm text-gray-600 mt-2">Max Temperature</div>
          </div>

          <!-- Min Temperature -->
          <div class="text-center p-4 bg-cyan-50 rounded-lg">
            <div class="text-lg font-bold text-cyan-600">
              {% if temps %} {{ "%.1f"|format(temps | min) }}¬∞C {% else %} N/A
              {% endif %}
            </div>
            <div class="text-sm text-gray-600 mt-2">Min Temperature</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Temperature Chart -->
  <section class="py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Temperature Trend</h2>
        <div class="h-96">
          <canvas id="temperatureChart"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- Historical Records Table -->
  <section class="py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="bg-white rounded-2xl shadow-xl p-8">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-gray-900">Historical Records</h2>
          <div class="flex items-center space-x-4">
            <span class="text-sm text-gray-500"
              >{{ history.records|length }} records</span
            >
            <button
              onclick="exportData()"
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
            >
              Export Data
            </button>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Date & Time
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Temperature
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Condition
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Wind
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Precipitation
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  AQI
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for record in history.records[:50] %}
              <!-- Limit to first 50 records for performance -->
              <tr class="hover:bg-gray-50">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  {{ record.created_at.strftime('%Y-%m-%d %H:%M') if
                  record.created_at else 'N/A' }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="text-sm font-medium text-gray-900">
                    {% if record.current_temp_c %} {{
                    "%.1f"|format(record.current_temp_c) }}¬∞C {% else %} N/A {%
                    endif %}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                  {{ record.current_condition or 'N/A' }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                  {% if record.wind_kph %} {{ record.wind_kph }} km/h {{
                  record.wind_dir or '' }} {% else %} N/A {% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                  {% if record.precipitation_mm %} {{ record.precipitation_mm }}
                  mm {% else %} 0 mm {% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  {% if record.us_aqi %}
                  <span
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {% if record.us_aqi <= 50 %}bg-green-100 text-green-800 {% elif record.us_aqi <= 100 %}bg-yellow-100 text-yellow-800 {% elif record.us_aqi <= 150 %}bg-orange-100 text-orange-800 {% else %}bg-red-100 text-red-800{% endif %}"
                  >
                    {{ record.us_aqi }}
                  </span>
                  {% else %}
                  <span class="text-gray-400">N/A</span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          {% if history.records|length > 50 %}
          <div class="px-6 py-4 text-center border-t border-gray-200">
            <p class="text-sm text-gray-500">
              Showing first 50 records of {{ history.records|length }} total
              records
            </p>
            <button
              onclick="loadMoreRecords()"
              class="mt-2 text-blue-600 hover:text-blue-800 text-sm font-medium"
            >
              Load More Records
            </button>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  {% else %}
  <!-- No Data State -->
  <section class="py-16">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <div class="bg-white rounded-2xl shadow-xl p-12">
        <div
          class="w-24 h-24 bg-gray-100 rounded-full mx-auto mb-6 flex items-center justify-center"
        >
          <svg
            class="w-12 h-12 text-gray-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
            ></path>
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-gray-900 mb-4">
          No Historical Data Available
        </h2>
        <p class="text-gray-600 mb-8">
          We don't have any historical weather data for this location yet. Start
          by checking the current weather to begin data collection.
        </p>
        <a
          href="{{ url_for('weather', lat=history.location.lat, lon=history.location.lon) }}"
          class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
        >
          Get Current Weather
        </a>
      </div>
    </div>
  </section>
  {% endif %}
</div>

<!-- Historical data as JSON for JavaScript -->
<script type="application/json" id="historyData">
  {
      "location": {
          "lat": {{ history.location.lat }},
          "lon": {{ history.location.lon }},
          "name": "{{ history.location.name }}"
      },
      "records": [
          {% for record in history.records %}
          {
              "date": "{{ record.created_at.isoformat() if record.created_at else '' }}",
              "temperature": {{ record.current_temp_c or 'null' }},
              "condition": "{{ record.current_condition or '' }}",
              "wind_kph": {{ record.wind_kph or 'null' }},
              "precipitation": {{ record.precipitation_mm or 'null' }},
              "aqi": {{ record.us_aqi or 'null' }}
          }{% if not loop.last %},{% endif %}
          {% endfor %}
      ]
  }
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const historyData = JSON.parse(
      document.getElementById("historyData").textContent
    );

    // Create temperature chart if we have data
    if (historyData.records && historyData.records.length > 0) {
      createTemperatureChart(historyData.records);
    }

    function createTemperatureChart(records) {
      const ctx = document.getElementById("temperatureChart");
      if (!ctx) return;

      // Filter records with valid temperature data
      const validRecords = records.filter(
        (r) => r.temperature !== null && r.date
      );

      if (validRecords.length === 0) return;

      // Prepare data for Chart.js
      const labels = validRecords.map((r) => {
        const date = new Date(r.date);
        return date.toLocaleDateString("en-US", {
          month: "short",
          day: "numeric",
          hour: "2-digit",
        });
      });

      const temperatures = validRecords.map((r) => r.temperature);

      new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "Temperature (¬∞C)",
              data: temperatures,
              borderColor: "rgb(59, 130, 246)",
              backgroundColor: "rgba(59, 130, 246, 0.1)",
              tension: 0.4,
              fill: true,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: false,
              title: {
                display: true,
                text: "Temperature (¬∞C)",
              },
            },
            x: {
              title: {
                display: true,
                text: "Date & Time",
              },
            },
          },
          plugins: {
            title: {
              display: true,
              text: `Temperature History - ${historyData.location.name}`,
            },
            legend: {
              display: false,
            },
          },
        },
      });
    }

    // Export data functionality
    window.exportData = function () {
      const csvContent = [
        [
          "Date",
          "Temperature (¬∞C)",
          "Condition",
          "Wind (km/h)",
          "Precipitation (mm)",
          "AQI",
        ].join(","),
        ...historyData.records.map((record) =>
          [
            record.date,
            record.temperature || "",
            `"${record.condition || ""}"`,
            record.wind_kph || "",
            record.precipitation || "",
            record.aqi || "",
          ].join(",")
        ),
      ].join("\n");

      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute(
        "download",
        `weather_history_${historyData.location.name
          .replace(/[^a-z0-9]/gi, "_")
          .toLowerCase()}_${new Date().toISOString().split("T")[0]}.csv`
      );
      link.style.visibility = "hidden";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showMessage("Weather data exported successfully!", "success");
    };

    // Load more records functionality
    window.loadMoreRecords = function () {
      // This would typically make an API call to get more records
      showMessage(
        "Load more functionality would be implemented with pagination",
        "info"
      );
    };

    // Message display function
    function showMessage(message, type) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `fixed top-24 right-4 z-50 px-4 py-3 rounded-lg shadow-lg text-white max-w-sm transform translate-x-full transition-transform duration-300 ${
        type === "success"
          ? "bg-green-500"
          : type === "info"
          ? "bg-blue-500"
          : "bg-red-500"
      }`;
      messageDiv.innerHTML = `
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                ${message}
            </div>
        `;

      document.body.appendChild(messageDiv);

      // Animate in
      setTimeout(() => {
        messageDiv.style.transform = "translateX(0)";
      }, 100);

      // Remove after 3 seconds
      setTimeout(() => {
        messageDiv.style.transform = "translateX(100%)";
        setTimeout(() => messageDiv.remove(), 300);
      }, 3000);
    }
  });
</script>
{% endblock %}
